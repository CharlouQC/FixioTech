<html>
<head>
    <title>backend\controleurs\controleurRendezVous.js</title>
    <style type="text/css" media="screen">
        #editor {
            position: absolute;
            top: 40px;
            right: 0;
            bottom: 0;
            left: 0;
        }
    </style>
</head>
<body style="font-family: 'DejaVu Sans', Arial, Helvetica, sans-serif">
<h3 style="margin-bottom: 0">backend\controleurs\controleurRendezVous.js (<b>187</b> lines of code) (<a href="controleurRendezVous.js">raw</a>):</h3>
<div id="editor">import { db } from &quot;../config/databaseConnexion.js&quot;;

const getRendezVous = (req, res, next) =&gt; {
  const { client_id, employe_id } = req.query;
  let sql = &quot;SELECT * FROM rendez_vous&quot;;
  const params = [];

  if (client_id) {
    sql += &quot; WHERE client_id = ?&quot;;
    params.push(client_id);
  } else if (employe_id) {
    sql += &quot; WHERE employe_id = ?&quot;;
    params.push(employe_id);
  }

  sql += &quot; ORDER BY date_rdv ASC, heure_rdv ASC&quot;;

  db.query(sql, params, (err, results) =&gt; {
    if (err) return next(err);
    res.json(results);
  });
};

const getRendezVousById = async (req, res, next) =&gt; {
  const { id } = req.params;
  db.query(&quot;SELECT * FROM rendez_vous WHERE id = ?&quot;, [id], (err, results) =&gt; {
    if (err) {
      return next(err);
    }
    if (results.length === 0) {
      return res.status(404).json({ message: &quot;Rendez-vous non trouv&eacute;&quot; });
    }
    res.json(results[0]);
  });
};

function colonnesJour(dateISO) {
  const j = new Date(`${dateISO}T00:00:00`).getDay();
  const noms = [
    &quot;dimanche&quot;,
    &quot;lundi&quot;,
    &quot;mardi&quot;,
    &quot;mercredi&quot;,
    &quot;jeudi&quot;,
    &quot;vendredi&quot;,
    &quot;samedi&quot;,
  ];
  const jour = noms[j];
  return { debutCol: `${jour}_debut`, finCol: `${jour}_fin` };
}

const addRendezVous = (req, res, next) =&gt; {
  const { client_id, employe_id, date_rdv, heure_rdv } = req.body;
  const description_probleme =
    (req.body.description_probleme ?? &quot;&quot;) === &quot;&quot;
      ? null
      : req.body.description_probleme;

  if (!client_id || !date_rdv || !heure_rdv) {
    return res
      .status(400)
      .json({ message: &quot;client_id, date_rdv et heure_rdv sont requis&quot; });
  }

  const { debutCol, finCol } = colonnesJour(date_rdv);

  // Si un employe_id est fourni: v&eacute;rifier disponibilit&eacute;.
  // Sinon: choisir automatiquement un employ&eacute; disponible.
  const baseSql = `
    SELECT u.id
    FROM utilisateurs u
    JOIN horaires h ON h.employe_id = u.id
    LEFT JOIN rendez_vous r
      ON r.employe_id = u.id AND r.date_rdv = ? AND r.heure_rdv = ?
    WHERE u.role = 'employe'
      AND h.${debutCol} IS NOT NULL
      AND h.${finCol}   IS NOT NULL
      AND h.${debutCol} &lt;= ?
      AND ? &lt; h.${finCol}
      AND r.id IS NULL
  `;

  const params = [date_rdv, heure_rdv, heure_rdv, heure_rdv];

  const sql = employe_id
    ? `${baseSql} AND u.id = ?`
    : `${baseSql} ORDER BY u.nom_complet ASC LIMIT 1`;

  const finalParams = employe_id ? [...params, employe_id] : params;

  db.query(sql, finalParams, (err, rows) =&gt; {
    if (err) return next(err);
    if (!rows || rows.length === 0) {
      return res
        .status(409)
        .json({ message: &quot;Aucun employ&eacute; disponible pour ce cr&eacute;neau.&quot; });
    }
    const chosenEmployeId = employe_id || rows[0].id;

    const insertSql = `
      INSERT INTO rendez_vous (client_id, employe_id, date_rdv, heure_rdv, description_probleme)
      VALUES (?, ?, ?, ?, ?)
    `;
    const insertParams = [
      client_id,
      chosenEmployeId,
      date_rdv,
      heure_rdv,
      description_probleme,
    ];

    db.query(insertSql, insertParams, (err2, r2) =&gt; {
      if (err2) return next(err2);
      res.status(201).json({
        id: r2.insertId,
        client_id,
        employe_id: chosenEmployeId,
        date_rdv,
        heure_rdv,
        description_probleme,
      });
    });
  });
};

const updateRendezVous = async (req, res, next) =&gt; {
  const { id } = req.params;
  const { client_id, employe_id, date_rdv, heure_rdv } = req.body;
  const description_probleme = emptyToNull(req.body.description_probleme);

  const sql = `
    UPDATE rendez_vous
    SET client_id = ?, employe_id = ?, date_rdv = ?, heure_rdv = ?, description_probleme = ?
    WHERE id = ?
  `;
  const params = [
    client_id,
    employe_id,
    date_rdv,
    heure_rdv,
    description_probleme,
    id,
  ];

  db.query(sql, params, (err, results) =&gt; {
    if (err) return next(err);
    if (results.affectedRows === 0) {
      return res.status(404).json({ message: &quot;Rendez-vous non trouv&eacute;&quot; });
    }
    res.status(200).json({
      id,
      client_id,
      employe_id,
      date_rdv,
      heure_rdv,
      description_probleme,
    });
  });
};

const deleteRendezVous = async (req, res, next) =&gt; {
  const { id } = req.params;

  db.query(&quot;DELETE FROM rendez_vous WHERE id = ?&quot;, [id], (err, results) =&gt; {
    if (err) {
      return next(err);
    }
    if (results.affectedRows === 0) {
      return res.status(404).json({ message: &quot;Rendez-vous non trouv&eacute;&quot; });
    }
    res.status(200).json({ message: &quot;Rendez-vous supprim&eacute; avec succ&egrave;s&quot; });
  });
};

// --- LISTER les rendez-vous d'un EMPLOY&Eacute; donn&eacute; ---
const getRendezVousByEmployeId = async (req, res, next) =&gt; {
  const { employe_id } = req.params;
  db.query(
    `SELECT * 
     FROM rendez_vous 
     WHERE employe_id = ? 
     ORDER BY date_rdv ASC, heure_rdv ASC`,
    [employe_id],
    (err, results) =&gt; {
      if (err) return next(err);
      res.json(results);
    }
  );
};

// --- LISTER les rendez-vous d'un CLIENT donn&eacute; ---
const getRendezVousByClientId = async (req, res, next) =&gt; {
  const { client_id } = req.params;
  db.query(
    `SELECT * 
     FROM rendez_vous 
     WHERE client_id = ? 
     ORDER BY date_rdv ASC, heure_rdv ASC`,
    [client_id],
    (err, results) =&gt; {
      if (err) return next(err);
      res.json(results);
    }
  );
};

export {
  getRendezVous,
  getRendezVousById,
  addRendezVous,
  updateRendezVous,
  deleteRendezVous,
  getRendezVousByEmployeId,
  getRendezVousByClientId,
};
</div>
<script src="https://www.zeljkoobrenovic.com/tools/common/lib/ace/ace.js" type="text/javascript" charset="utf-8"></script>
<script>
    var editor = ace.edit("editor");
    editor.session.setMode("ace/mode/javascript");
    editor.setTheme("ace/theme/xcode");
    editor.setReadOnly(true);
    editor.setOption("wrap", true);
    editor.setPrintMarginColumn(120);
</script>
</body>
