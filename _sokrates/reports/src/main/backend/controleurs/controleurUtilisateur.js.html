<html>
<head>
    <title>backend/controleurs/controleurUtilisateur.js</title>
    <style type="text/css" media="screen">
        #editor {
            position: absolute;
            top: 40px;
            right: 0;
            bottom: 0;
            left: 0;
        }
    </style>
</head>
<body style="font-family: 'DejaVu Sans', Arial, Helvetica, sans-serif">
<h3 style="margin-bottom: 0">backend/controleurs/controleurUtilisateur.js (<b>156</b> lines of code) (<a href="controleurUtilisateur.js">raw</a>):</h3>
<div id="editor">import { db } from &quot;../config/databaseConnexion.js&quot;;
import { colonnesJour, baseDisponibiliteQuery } from &quot;utils.js&quot;;

const getUtilisateurs = (req, res, next) =&gt; {
  const { role } = req.query; // ex: employe, client, admin
  let sql = &quot;SELECT id, email, nom_complet, role FROM utilisateurs&quot;;
  const params = [];

  if (role) {
    sql += &quot; WHERE role = $1&quot;;
    params.push(role);
  }

  db.query(sql, params, (err, results) =&gt; {
    if (err) return next(err);
    res.json(results.rows);
  });
};

const getUtilisateurById = async (req, res, next) =&gt; {
  const { id } = req.params;

  db.query(
    &quot;SELECT id, email, nom_complet, role FROM utilisateurs WHERE id = $1&quot;,
    [id],
    (err, results) =&gt; {
      if (err) {
        return next(err);
      }
      const rows = results.rows;
      if (rows.length === 0) {
        return res.status(404).json({ message: &quot;Utilisateur non trouv&eacute;&quot; });
      }
      res.json(rows[0]);
    }
  );
};

const addUtilisateur = async (req, res, next) =&gt; {
  const { email, mot_de_passe, nom_complet, role = &quot;client&quot; } = req.body;

  if (!email || !mot_de_passe || !nom_complet) {
    return res.status(400).json({ message: &quot;Champs requis manquants&quot; });
  }

  const sql = `
    INSERT INTO utilisateurs (email, mot_de_passe, nom_complet, role)
    VALUES ($1, $2, $3, $4)
    RETURNING id, email, nom_complet, role
  `;

  db.query(sql, [email, mot_de_passe, nom_complet, role], (err, results) =&gt; {
    if (err) {
      return next(err);
    }
    const row = results.rows[0];
    res.status(201).json(row);
  });
};

const updateUtilisateur = async (req, res, next) =&gt; {
  const { id } = req.params;
  const { email, mot_de_passe, nom_complet, role } = req.body;

  const updateFields = [];
  const updateValues = [];

  if (email) {
    updateFields.push(`email = $${updateValues.length + 1}`);
    updateValues.push(email);
  }
  if (mot_de_passe) {
    updateFields.push(`mot_de_passe = $${updateValues.length + 1}`);
    updateValues.push(mot_de_passe);
  }
  if (nom_complet) {
    updateFields.push(`nom_complet = $${updateValues.length + 1}`);
    updateValues.push(nom_complet);
  }
  if (role) {
    updateFields.push(`role = $${updateValues.length + 1}`);
    updateValues.push(role);
  }

  if (updateFields.length === 0) {
    return res.status(400).json({ message: &quot;Aucun champ &agrave; mettre &agrave; jour&quot; });
  }

  // id devient le dernier param&egrave;tre
  updateValues.push(id);
  const idIndex = updateValues.length;

  const sql = `
    UPDATE utilisateurs
    SET ${updateFields.join(&quot;, &quot;)}
    WHERE id = $${idIndex}
    RETURNING id, email, nom_complet, role
  `;

  db.query(sql, updateValues, (err, results) =&gt; {
    if (err) {
      return next(err);
    }
    if (results.rowCount === 0) {
      return res.status(404).json({ message: &quot;Utilisateur non trouv&eacute;&quot; });
    }
    res.status(200).json(results.rows[0]);
  });
};

const deleteUtilisateur = async (req, res, next) =&gt; {
  const { id } = req.params;

  db.query(
    &quot;DELETE FROM utilisateurs WHERE id = $1&quot;,
    [id],
    (err, results) =&gt; {
      if (err) {
        return next(err);
      }
      if (results.rowCount === 0) {
        return res.status(404).json({ message: &quot;Utilisateur non trouv&eacute;&quot; });
      }
      res.status(200).json({ message: &quot;Utilisateur supprim&eacute; avec succ&egrave;s&quot; });
    }
  );
};

const loginUtilisateur = async (req, res, next) =&gt; {
  const { email, mot_de_passe } = req.body;

  if (!email || !mot_de_passe) {
    return res.status(400).json({ message: &quot;Champs requis manquants&quot; });
  }

  db.query(
    `
    SELECT id, email, nom_complet, role
    FROM utilisateurs
    WHERE email = $1 AND mot_de_passe = $2
  `,
    [email, mot_de_passe],
    (err, results) =&gt; {
      if (err) {
        return next(err);
      }
      const rows = results.rows;
      if (rows.length === 0) {
        return res
          .status(401)
          .json({ message: &quot;Email ou mot de passe incorrect&quot; });
      }
      res.status(200).json({
        message: &quot;Connexion r&eacute;ussie&quot;,
        utilisateur: rows[0],
      });
    }
  );
};

const getEmployesDisponibles = (req, res, next) =&gt; {
  const { date, heure } = req.query; // ex: 2025-10-31, 14:00
  if (!date || !heure) {
    return res.status(400).json({
      message: &quot;Param&egrave;tres 'date' et 'heure' requis (YYYY-MM-DD, HH:mm)&quot;,
    });
  }

  const { debutCol, finCol } = colonnesJour(date);

  // Requ&ecirc;tes communes, avec SELECT complet (id + email + nom + role)
  const sql =
    baseDisponibiliteQuery(debutCol, finCol) + &quot; ORDER BY u.nom_complet ASC&quot;;

  const params = [date, heure, heure, heure];

  db.query(sql, params, (err, results) =&gt; {
    if (err) return next(err);
    res.json(results.rows);
  });
};

export {
  getUtilisateurs, getUtilisateurById, addUtilisateur, updateUtilisateur, deleteUtilisateur, loginUtilisateur, getEmployesDisponibles,
};</div>
<script src="https://www.zeljkoobrenovic.com/tools/common/lib/ace/ace.js" type="text/javascript" charset="utf-8"></script>
<script>
    var editor = ace.edit("editor");
    editor.session.setMode("ace/mode/javascript");
    editor.setTheme("ace/theme/xcode");
    editor.setReadOnly(true);
    editor.setOption("wrap", true);
    editor.setPrintMarginColumn(120);
</script>
</body>
