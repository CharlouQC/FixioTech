<html>
<head>
    <title>backend\controleurs\controleurUtilisateur.js</title>
    <style type="text/css" media="screen">
        #editor {
            position: absolute;
            top: 40px;
            right: 0;
            bottom: 0;
            left: 0;
        }
    </style>
</head>
<body style="font-family: 'DejaVu Sans', Arial, Helvetica, sans-serif">
<h3 style="margin-bottom: 0">backend\controleurs\controleurUtilisateur.js (<b>184</b> lines of code) (<a href="controleurUtilisateur.js">raw</a>):</h3>
<div id="editor">import { db } from &quot;../config/databaseConnexion.js&quot;;

const getUtilisateurs = (req, res, next) =&gt; {
  const { role } = req.query; // ex: employe, client, admin
  let sql = &quot;SELECT id, email, nom_complet, role FROM utilisateurs&quot;;
  const params = [];
  if (role) {
    sql += &quot; WHERE role = ?&quot;;
    params.push(role);
  }
  db.query(sql, params, (err, results) =&gt; {
    if (err) return next(err);
    res.json(results);
  });
};

const getUtilisateurById = async (req, res, next) =&gt; {
  const { id } = req.params;
  db.query(
    &quot;SELECT id, email, nom_complet, role FROM utilisateurs WHERE id = ?&quot;,
    [id],
    (err, results) =&gt; {
      if (err) {
        return next(err);
      }
      if (results.length === 0) {
        return res.status(404).json({ message: &quot;Utilisateur non trouv&eacute;&quot; });
      }
      res.json(results[0]);
    }
  );
};

const addUtilisateur = async (req, res, next) =&gt; {
  const { email, mot_de_passe, nom_complet, role = &quot;client&quot; } = req.body;

  if (!email || !mot_de_passe || !nom_complet) {
    return res.status(400).json({ message: &quot;Champs requis manquants&quot; });
  }

  try {
    const [results] = await db.query(
      &quot;INSERT INTO utilisateurs (email, mot_de_passe, nom_complet, role) VALUES (?, ?, ?, ?)&quot;,
      [email, mot_de_passe, nom_complet, role]
    );

    res.status(201).json({
      id: results.insertId,
      email,
      nom_complet,
      role,
    });
  } catch (err) {
    if (err.code === &quot;ER_DUP_ENTRY&quot;) {
      return res.status(409).json({ message: &quot;Cet email est d&eacute;j&agrave; utilis&eacute;&quot; });
    }
    return next(err);
  }
};

const updateUtilisateur = async (req, res, next) =&gt; {
  const { id } = req.params;
  const { email, mot_de_passe, nom_complet, role } = req.body;

  const updateFields = [];
  const updateValues = [];

  if (email) {
    updateFields.push(&quot;email = ?&quot;);
    updateValues.push(email);
  }
  if (mot_de_passe) {
    updateFields.push(&quot;mot_de_passe = ?&quot;);
    updateValues.push(mot_de_passe);
  }
  if (nom_complet) {
    updateFields.push(&quot;nom_complet = ?&quot;);
    updateValues.push(nom_complet);
  }
  if (role) {
    updateFields.push(&quot;role = ?&quot;);
    updateValues.push(role);
  }

  if (updateFields.length === 0) {
    return res.status(400).json({ message: &quot;Aucun champ &agrave; mettre &agrave; jour&quot; });
  }

  updateValues.push(id);

  db.query(
    `UPDATE utilisateurs SET ${updateFields.join(&quot;, &quot;)} WHERE id = ?`,
    updateValues,
    (err, results) =&gt; {
      if (err) {
        return next(err);
      }
      if (results.affectedRows === 0) {
        return res.status(404).json({ message: &quot;Utilisateur non trouv&eacute;&quot; });
      }
      res.status(200).json({
        id,
        ...(email &amp;&amp; { email }),
        ...(nom_complet &amp;&amp; { nom_complet }),
        ...(role &amp;&amp; { role }),
      });
    }
  );
};

const deleteUtilisateur = async (req, res, next) =&gt; {
  const { id } = req.params;

  db.query(&quot;DELETE FROM utilisateurs WHERE id = ?&quot;, [id], (err, results) =&gt; {
    if (err) {
      return next(err);
    }
    if (results.affectedRows === 0) {
      return res.status(404).json({ message: &quot;Utilisateur non trouv&eacute;&quot; });
    }
    res.status(200).json({ message: &quot;Utilisateur supprim&eacute; avec succ&egrave;s&quot; });
  });
};

const loginUtilisateur = async (req, res, next) =&gt; {
  const { email, mot_de_passe } = req.body;

  if (!email || !mot_de_passe) {
    return res.status(400).json({ message: &quot;Champs requis manquants&quot; });
  }

  db.query(
    &quot;SELECT id, email, nom_complet, role FROM utilisateurs WHERE email = ? AND mot_de_passe = ?&quot;,
    [email, mot_de_passe],
    (err, results) =&gt; {
      if (err) {
        return next(err);
      }
      if (results.length === 0) {
        return res
          .status(401)
          .json({ message: &quot;Email ou mot de passe incorrect&quot; });
      }
      res.status(200).json({
        message: &quot;Connexion r&eacute;ussie&quot;,
        utilisateur: results[0],
      });
    }
  );
};

function colonnesJour(dateISO) {
  // 0=dimanche .. 6=samedi
  const j = new Date(`${dateISO}T00:00:00`).getDay();
  const noms = [
    &quot;dimanche&quot;,
    &quot;lundi&quot;,
    &quot;mardi&quot;,
    &quot;mercredi&quot;,
    &quot;jeudi&quot;,
    &quot;vendredi&quot;,
    &quot;samedi&quot;,
  ];
  const jour = noms[j];
  return { debutCol: `${jour}_debut`, finCol: `${jour}_fin` };
}

const getEmployesDisponibles = (req, res, next) =&gt; {
  const { date, heure } = req.query; // ex: 2025-10-31, 14:00
  if (!date || !heure) {
    return res.status(400).json({
      message: &quot;Param&egrave;tres 'date' et 'heure' requis (YYYY-MM-DD, HH:mm)&quot;,
    });
  }

  const { debutCol, finCol } = colonnesJour(date);

  const sql = `
    SELECT u.id, u.email, u.nom_complet, u.role
    FROM utilisateurs u
    JOIN horaires h ON h.employe_id = u.id
    LEFT JOIN rendez_vous r
      ON r.employe_id = u.id AND r.date_rdv = ? AND r.heure_rdv = ?
    WHERE u.role = 'employe'
      AND h.${debutCol} IS NOT NULL
      AND h.${finCol}   IS NOT NULL
      AND h.${debutCol} &lt;= ?
      AND ? &lt; h.${finCol}
      AND r.id IS NULL
    ORDER BY u.nom_complet ASC
  `;
  const params = [date, heure, heure, heure];

  db.query(sql, params, (err, rows) =&gt; {
    if (err) return next(err);
    res.json(rows);
  });
};

export {
  getUtilisateurs,
  getUtilisateurById,
  addUtilisateur,
  updateUtilisateur,
  deleteUtilisateur,
  loginUtilisateur,
  getEmployesDisponibles,
};
</div>
<script src="https://www.zeljkoobrenovic.com/tools/common/lib/ace/ace.js" type="text/javascript" charset="utf-8"></script>
<script>
    var editor = ace.edit("editor");
    editor.session.setMode("ace/mode/javascript");
    editor.setTheme("ace/theme/xcode");
    editor.setReadOnly(true);
    editor.setOption("wrap", true);
    editor.setPrintMarginColumn(120);
</script>
</body>
