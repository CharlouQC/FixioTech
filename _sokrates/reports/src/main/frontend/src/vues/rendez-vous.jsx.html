<html>
<head>
    <title>frontend\src\vues\rendez-vous.jsx</title>
    <style type="text/css" media="screen">
        #editor {
            position: absolute;
            top: 40px;
            right: 0;
            bottom: 0;
            left: 0;
        }
    </style>
</head>
<body style="font-family: 'DejaVu Sans', Arial, Helvetica, sans-serif">
<h3 style="margin-bottom: 0">frontend\src\vues\rendez-vous.jsx (<b>336</b> lines of code) (<a href="rendez-vous.jsx">raw</a>):</h3>
<div id="editor">import React, { useEffect, useMemo, useState } from &quot;react&quot;;
import &quot;./rendez-vous.css&quot;;
import { useAuth } from &quot;../context/AuthContext&quot;;
import { addRendezVous } from &quot;../../services/apiRendezVous&quot;;
import {
  getEmployes,
  getEmployesDisponibles,
} from &quot;../../services/apiUtilisateur&quot;;

const RendezVous = () =&gt; {
  const { user } = useAuth();

  // ---------- UI state ----------
  const [formData, setFormData] = useState({
    service: &quot;&quot;,
    date: &quot;&quot;,
    heure: &quot;&quot;,
    technicien: &quot;&quot;, // employe_id (string)
    description: &quot;&quot;,
  });

  // Tous les employ&eacute;s (pour affichage quand pas de date)
  const [allEmployes, setAllEmployes] = useState([]);
  const [loadingAllTech, setLoadingAllTech] = useState(true);

  // Employ&eacute;s disponibles pour un cr&eacute;neau (date+heure)
  const [techniciensDispo, setTechniciensDispo] = useState([]);
  const [loadingDispo, setLoadingDispo] = useState(false);

  const [isLoading, setIsLoading] = useState(false);
  const [error, setError] = useState(&quot;&quot;);
  const [successMessage, setSuccessMessage] = useState(&quot;&quot;);

  // ---------- Constantes ----------
  const services = [
    &quot;R&eacute;paration d'ordinateurs&quot;,
    &quot;R&eacute;paration de cellulaires&quot;,
    &quot;R&eacute;paration de tablettes&quot;,
    &quot;Services &agrave; domicile&quot;,
    &quot;Support technique&quot;,
    &quot;Formation personnalis&eacute;e&quot;,
  ];

  // 08:00 &rarr; 18:00, format &quot;HH:mm&quot;
  const creneauxHoraires = useMemo(
    () =&gt;
      Array.from({ length: 11 }, (_, i) =&gt; {
        const h = String(i + 8).padStart(2, &quot;0&quot;);
        return `${h}:00`;
      }),
    []
  );

  // ---------- Helpers ----------
  const getMinDate = () =&gt; {
    const today = new Date();
    return today.toISOString().split(&quot;T&quot;)[0];
  };

  const handleChange = (e) =&gt; {
    setError(&quot;&quot;);
    setFormData((f) =&gt; ({ ...f, [e.target.name]: e.target.value }));
  };

  useEffect(() =&gt; {
    let alive = true;
    setLoadingAllTech(true);
    setError(&quot;&quot;);

    getEmployes()
      .then((list) =&gt; {
        if (!alive) return;
        setAllEmployes(list || []);
      })
      .catch((err) =&gt; {
        if (!alive) return;
        setAllEmployes([]);
        setError(err.message || &quot;Erreur lors du chargement des techniciens.&quot;);
      })
      .finally(() =&gt; alive &amp;&amp; setLoadingAllTech(false));

    return () =&gt; {
      alive = false;
    };
  }, []);

  // Charger dynamiquement les techniciens disponibles d&egrave;s qu'on a date + heure
  useEffect(() =&gt; {
    const { date, heure } = formData;

    // Pas de date &rarr; on n&rsquo;appelle pas /disponibles
    if (!date) {
      setTechniciensDispo([]);
      return;
    }
    // Date sans heure &rarr; on attend l&rsquo;heure
    if (date &amp;&amp; !heure) {
      setTechniciensDispo([]);
      return;
    }

    let alive = true;
    setLoadingDispo(true);
    setError(&quot;&quot;);

    getEmployesDisponibles(date, heure)
      .then((list) =&gt; {
        if (!alive) return;
        setTechniciensDispo(list || []);
        // Si un tech s&eacute;lectionn&eacute; n'est plus dans la liste, on le d&eacute;selectionne
        if (
          formData.technicien &amp;&amp;
          !(list || []).some(
            (t) =&gt; String(t.id) === String(formData.technicien)
          )
        ) {
          setFormData((f) =&gt; ({ ...f, technicien: &quot;&quot; }));
        }
      })
      .catch((err) =&gt; {
        if (!alive) return;
        setTechniciensDispo([]);
        setError(
          err.message ||
            &quot;Erreur lors du chargement des techniciens disponibles.&quot;
        );
      })
      .finally(() =&gt; alive &amp;&amp; setLoadingDispo(false));

    return () =&gt; {
      alive = false;
    };
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [formData.date, formData.heure]);

  // ---------- Submit ----------
  const handleSubmit = async (e) =&gt; {
    e.preventDefault();
    setError(&quot;&quot;);
    setSuccessMessage(&quot;&quot;);

    if (!formData.service) return setError(&quot;Veuillez s&eacute;lectionner un service&quot;);
    if (!formData.date) return setError(&quot;Veuillez s&eacute;lectionner une date&quot;);
    if (!formData.heure) return setError(&quot;Veuillez s&eacute;lectionner une heure&quot;);
    if (!formData.description.trim())
      return setError(&quot;Veuillez d&eacute;crire bri&egrave;vement votre probl&egrave;me&quot;);

    const dateSelectionnee = new Date(formData.date);
    const aujourdhui = new Date();
    aujourdhui.setHours(0, 0, 0, 0);

    if (dateSelectionnee &lt; aujourdhui)
      return setError(&quot;La date ne peut pas &ecirc;tre dans le pass&eacute;&quot;);

    if (!user?.id) return setError(&quot;Vous devez &ecirc;tre connect&eacute; pour r&eacute;server.&quot;);

    setIsLoading(true);

    try {
      await addRendezVous({
        client_id: user.id,
        date_rdv: formData.date,
        heure_rdv: formData.heure,
        description_probleme: formData.description,
      });

      setSuccessMessage(&quot;Votre rendez-vous a &eacute;t&eacute; r&eacute;serv&eacute; avec succ&egrave;s !&quot;);
      setFormData({ service: &quot;&quot;, date: &quot;&quot;, heure: &quot;&quot;, description: &quot;&quot; });
    } catch (err) {
      setError(err.message || &quot;Aucun technicien disponible &agrave; cette heure.&quot;);
    } finally {
      setIsLoading(false);
    }
  };

  // Liste de techniciens &agrave; afficher selon le contexte :
  // - Pas de date &rarr; TOUS les employ&eacute;s (allEmployes)
  // - Date+heure &rarr; seulement les disponibles (techniciensDispo)
  const afficherAll = !(formData.date &amp;&amp; formData.heure);
  const listeTechniciens = afficherAll ? allEmployes : techniciensDispo;
  const loadingTech = afficherAll ? loadingAllTech : loadingDispo;

  // ---------- Render ----------
  return (
    &lt;div className=&quot;rendez-vous-container&quot;&gt;
      &lt;div className=&quot;rendez-vous-header&quot;&gt;
        &lt;h1&gt;Prendre un Rendez-vous&lt;/h1&gt;
        &lt;p className=&quot;rendez-vous-intro&quot;&gt;
          S&eacute;lectionnez un service, choisissez un technicien disponible et
          planifiez votre rendez-vous en quelques clics.
        &lt;/p&gt;
      &lt;/div&gt;

      &lt;div className=&quot;rendez-vous-content&quot;&gt;
        {/* TECHNICIENS */}
        &lt;div className=&quot;techniciens-section&quot;&gt;
          &lt;h2&gt;Techniciens {afficherAll ? &quot; (tous)&quot; : &quot;Disponibles&quot;}&lt;/h2&gt;

          {afficherAll ? (
            // Aucun date s&eacute;lectionn&eacute;e &rarr; on affiche TOUS les employ&eacute;s
            loadingTech ? (
              &lt;div className=&quot;loading-tech&quot;&gt;Chargement des techniciens&hellip;&lt;/div&gt;
            ) : listeTechniciens.length === 0 ? (
              &lt;div className=&quot;no-tech&quot;&gt;
                Aucun technicien disponible pour ce cr&eacute;neau.
              &lt;/div&gt;
            ) : (
              &lt;div className=&quot;techniciens-liste&quot;&gt;
                {listeTechniciens.map((t) =&gt; (
                  &lt;div
                    key={t.id}
                    className={`technicien-card ${
                      formData.technicien === String(t.id)
                        ? &quot;technicien-selected&quot;
                        : &quot;&quot;
                    }`}
                    onClick={() =&gt;
                      setFormData((f) =&gt; ({ ...f, technicien: String(t.id) }))
                    }
                  &gt;
                    &lt;div className=&quot;technicien-avatar&quot;&gt;
                      {String(t.nom_complet || t.email || &quot;T&quot;)
                        .charAt(0)
                        .toUpperCase()}
                    &lt;/div&gt;
                    &lt;div className=&quot;technicien-info&quot;&gt;
                      &lt;h3&gt;{t.nom_complet || &quot;Technicien&quot;}&lt;/h3&gt;
                      &lt;p&gt;Support &amp; R&eacute;paration&lt;/p&gt;
                    &lt;/div&gt;
                    {formData.technicien === String(t.id) &amp;&amp; (
                      &lt;div className=&quot;technicien-check&quot;&gt;✓&lt;/div&gt;
                    )}
                  &lt;/div&gt;
                ))}
              &lt;/div&gt;
            )
          ) : !formData.heure ? (
            // Date choisie mais pas l'heure
            &lt;div className=&quot;no-tech&quot;&gt;
              S&eacute;lectionnez une heure pour voir les techniciens disponibles.
            &lt;/div&gt;
          ) : loadingTech ? (
            &lt;div className=&quot;loading-tech&quot;&gt;Chargement des techniciens&hellip;&lt;/div&gt;
          ) : listeTechniciens.length === 0 ? (
            // Date + heure choisies ET aucun dispo
            &lt;div className=&quot;no-tech&quot;&gt;
              Aucun technicien disponible pour ce cr&eacute;neau.
            &lt;/div&gt;
          ) : (
            &lt;div className=&quot;techniciens-liste&quot;&gt;
              {listeTechniciens.map((t) =&gt; (
                &lt;div
                  key={t.id}
                  className={`technicien-card ${
                    formData.technicien === String(t.id)
                      ? &quot;technicien-selected&quot;
                      : &quot;&quot;
                  }`}
                  onClick={() =&gt;
                    setFormData((f) =&gt; ({ ...f, technicien: String(t.id) }))
                  }
                &gt;
                  &lt;div className=&quot;technicien-avatar&quot;&gt;
                    {String(t.nom_complet || t.email || &quot;T&quot;)
                      .charAt(0)
                      .toUpperCase()}
                  &lt;/div&gt;
                  &lt;div className=&quot;technicien-info&quot;&gt;
                    &lt;h3&gt;{t.nom_complet || &quot;Technicien&quot;}&lt;/h3&gt;
                    &lt;p&gt;Support &amp; R&eacute;paration&lt;/p&gt;
                  &lt;/div&gt;
                  {formData.technicien === String(t.id) &amp;&amp; (
                    &lt;div className=&quot;technicien-check&quot;&gt;✓&lt;/div&gt;
                  )}
                &lt;/div&gt;
              ))}
            &lt;/div&gt;
          )}
        &lt;/div&gt;

        {/* FORMULAIRE */}
        &lt;div className=&quot;formulaire-section&quot;&gt;
          &lt;h2&gt;D&eacute;tails du Rendez-vous&lt;/h2&gt;

          {error &amp;&amp; &lt;div className=&quot;error-message&quot;&gt;{error}&lt;/div&gt;}
          {successMessage &amp;&amp; (
            &lt;div className=&quot;success-message&quot;&gt;{successMessage}&lt;/div&gt;
          )}

          &lt;form onSubmit={handleSubmit} className=&quot;rendez-vous-form&quot;&gt;
            &lt;div className=&quot;form-groupe&quot;&gt;
              &lt;label htmlFor=&quot;service&quot;&gt;Service requis *&lt;/label&gt;
              &lt;select
                id=&quot;service&quot;
                name=&quot;service&quot;
                value={formData.service}
                onChange={handleChange}
                className=&quot;form-select&quot;
              &gt;
                &lt;option value=&quot;&quot;&gt;-- S&eacute;lectionnez un service --&lt;/option&gt;
                {services.map((service) =&gt; (
                  &lt;option key={service} value={service}&gt;
                    {service}
                  &lt;/option&gt;
                ))}
              &lt;/select&gt;
            &lt;/div&gt;

            &lt;div className=&quot;form-row&quot;&gt;
              &lt;div className=&quot;form-groupe&quot;&gt;
                &lt;label htmlFor=&quot;date&quot;&gt;Date *&lt;/label&gt;
                &lt;input
                  type=&quot;date&quot;
                  id=&quot;date&quot;
                  name=&quot;date&quot;
                  value={formData.date}
                  onChange={handleChange}
                  min={getMinDate()}
                  className=&quot;form-input&quot;
                /&gt;
              &lt;/div&gt;

              &lt;div className=&quot;form-groupe&quot;&gt;
                &lt;label htmlFor=&quot;heure&quot;&gt;Heure *&lt;/label&gt;
                &lt;select
                  id=&quot;heure&quot;
                  name=&quot;heure&quot;
                  value={formData.heure}
                  onChange={handleChange}
                  className=&quot;form-select&quot;
                &gt;
                  &lt;option value=&quot;&quot;&gt;-- S&eacute;lectionnez une heure --&lt;/option&gt;
                  {creneauxHoraires.map((h) =&gt; (
                    &lt;option key={h} value={h}&gt;
                      {h}
                    &lt;/option&gt;
                  ))}
                &lt;/select&gt;
              &lt;/div&gt;
            &lt;/div&gt;

            &lt;div className=&quot;form-groupe&quot;&gt;
              &lt;label htmlFor=&quot;description&quot;&gt;Description du probl&egrave;me *&lt;/label&gt;
              &lt;textarea
                id=&quot;description&quot;
                name=&quot;description&quot;
                value={formData.description}
                onChange={handleChange}
                placeholder=&quot;D&eacute;crivez bri&egrave;vement le probl&egrave;me technique que vous rencontrez...&quot;
                rows=&quot;5&quot;
                className=&quot;form-textarea&quot;
              /&gt;
            &lt;/div&gt;

            &lt;button
              type=&quot;submit&quot;
              className=&quot;bouton-soumettre&quot;
              disabled={isLoading}
            &gt;
              {isLoading ? &quot;Envoi en cours...&quot; : &quot;R&eacute;server le rendez-vous&quot;}
            &lt;/button&gt;
          &lt;/form&gt;

          &lt;p className=&quot;form-note&quot;&gt;
            * Champs obligatoires. Un technicien vous contactera dans les plus
            brefs d&eacute;lais pour confirmer votre rendez-vous.
          &lt;/p&gt;
        &lt;/div&gt;
      &lt;/div&gt;
    &lt;/div&gt;
  );
};

export default RendezVous;
</div>
<script src="https://www.zeljkoobrenovic.com/tools/common/lib/ace/ace.js" type="text/javascript" charset="utf-8"></script>
<script>
    var editor = ace.edit("editor");
    editor.session.setMode("ace/mode/html");
    editor.setTheme("ace/theme/xcode");
    editor.setReadOnly(true);
    editor.setOption("wrap", true);
    editor.setPrintMarginColumn(120);
</script>
</body>
