<html>
<head>
    <title>frontend/src/vues/horaires.jsx</title>
    <style type="text/css" media="screen">
        #editor {
            position: absolute;
            top: 40px;
            right: 0;
            bottom: 0;
            left: 0;
        }
    </style>
</head>
<body style="font-family: 'DejaVu Sans', Arial, Helvetica, sans-serif">
<h3 style="margin-bottom: 0">frontend/src/vues/horaires.jsx (<b>287</b> lines of code) (<a href="horaires.jsx">raw</a>):</h3>
<div id="editor">import React, { useEffect, useMemo, useState } from &quot;react&quot;;
import &quot;./horaires.css&quot;;
import { useAuth } from &quot;../context/AuthContext&quot;;
import {
  getHoraireByEmploye,
  addHoraire,
  updateHoraire,
} from &quot;../../services/apiHoraire&quot;;

const JOURS = [
  &quot;Lundi&quot;,
  &quot;Mardi&quot;,
  &quot;Mercredi&quot;,
  &quot;Jeudi&quot;,
  &quot;Vendredi&quot;,
  &quot;Samedi&quot;,
  &quot;Dimanche&quot;,
];

// Helpers de mapping Front &lt;-&gt; Backend
const k = (jour, type) =&gt; `${jour.toLowerCase()}_${type}`; // ex: &quot;Lundi&quot;,&quot;debut&quot; -&gt; &quot;lundi_debut&quot;

const Horaires = () =&gt; {
  const { user, role } = useAuth();
  const isEmploye = role === &quot;employe&quot;;

  // &Eacute;tat pour les services s&eacute;lectionn&eacute;s
  const [servicesSelectionnes, setServicesSelectionnes] = useState([]);

  // &Eacute;tat pour les horaires par jour (d&eacute;but et fin) + actif
  const [horairesParJour, setHorairesParJour] = useState(() =&gt; {
    // &eacute;tat initial : tout inactif, 08:00-17:00 par d&eacute;faut
    const base = {};
    JOURS.forEach((j) =&gt; {
      base[j] = { actif: false, debut: &quot;08:00&quot;, fin: &quot;17:00&quot; };
    });
    return base;
  });

  const [horaireId, setHoraireId] = useState(null);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState(&quot;&quot;);
  const [successMessage, setSuccessMessage] = useState(&quot;&quot;);

  // Liste des services disponibles
  const services = [
    &quot;R&eacute;paration d'ordinateurs&quot;,
    &quot;R&eacute;paration de cellulaires&quot;,
    &quot;R&eacute;paration de tablettes&quot;,
    &quot;Services &agrave; domicile&quot;,
    &quot;Support technique&quot;,
    &quot;Formation personnalis&eacute;e&quot;,
  ];

  // G&eacute;n&egrave;re les heures disponibles (8h &agrave; 18h)
  const heuresDisponibles = useMemo(
    () =&gt;
      Array.from({ length: 11 }, (_, i) =&gt; {
        const h = String(i + 8).padStart(2, &quot;0&quot;);
        return `${h}:00`;
      }),
    []
  );

  // Charger l'horaire existant pour l'employ&eacute; connect&eacute; (s&rsquo;il existe)
  useEffect(() =&gt; {
    if (!user?.id || !isEmploye) {
      setLoading(false);
      return;
    }

    setLoading(true);
    setError(&quot;&quot;);
    setSuccessMessage(&quot;&quot;);

    getHoraireByEmploye(user.id)
      .then((h) =&gt; {
        // Aucun horaire encore cr&eacute;&eacute; &rarr; cas normal : on laisse le formulaire vide
        if (!h) {
          setHoraireId(null);
          return; // âœ… PAS de setForm ici
        }

        const next = {};
        JOURS.forEach((jour) =&gt; {
          const debut = h[k(jour, &quot;debut&quot;)]; // ex: h.lundi_debut
          const fin = h[k(jour, &quot;fin&quot;)];
          const actif = debut != null &amp;&amp; fin != null;

          next[jour] = {
            actif,
            debut: actif ? String(debut).slice(0, 5) : &quot;08:00&quot;,
            fin: actif ? String(fin).slice(0, 5) : &quot;17:00&quot;,
          };
        });
        setHorairesParJour(next);
        setHoraireId(h.id);
      })
      .catch((err) =&gt; {
        // Toute autre erreur (r&eacute;seau/serveur)
        setError(err.message || &quot;Erreur lors du chargement de l'horaire.&quot;);
        setHoraireId(null);
      })
      .finally(() =&gt; setLoading(false));
  }, [user, isEmploye]);

  // G&egrave;re l'activation/d&eacute;sactivation d'un jour
  const handleJourToggle = (jour) =&gt; {
    setHorairesParJour((prev) =&gt; ({
      ...prev,
      [jour]: {
        ...prev[jour],
        actif: !prev[jour].actif,
      },
    }));
  };

  // G&egrave;re la s&eacute;lection/d&eacute;selection des services
  const handleServiceToggle = (service) =&gt; {
    setServicesSelectionnes((prev) =&gt;
      prev.includes(service)
        ? prev.filter((s) =&gt; s !== service)
        : [...prev, service]
    );
  };

  // G&egrave;re le changement d'heure de d&eacute;but
  const handleHeureDebutChange = (jour, heure) =&gt; {
    setHorairesParJour((prev) =&gt; ({
      ...prev,
      [jour]: {
        ...prev[jour],
        debut: heure,
      },
    }));
  };

  // G&egrave;re le changement d'heure de fin
  const handleHeureFinChange = (jour, heure) =&gt; {
    setHorairesParJour((prev) =&gt; ({
      ...prev,
      [jour]: {
        ...prev[jour],
        fin: heure,
      },
    }));
  };

  // Sauvegarde (create ou update)
  const handleSauvegarder = async () =&gt; {
    setError(&quot;&quot;);
    setSuccessMessage(&quot;&quot;);

    // Validation : si un jour est actif, fin &gt; d&eacute;but
    for (const jour of JOURS) {
      const d = horairesParJour[jour];
      if (d.actif &amp;&amp; d.debut &gt;= d.fin) {
        setError(
          `Erreur pour ${jour} : L'heure de fin doit &ecirc;tre apr&egrave;s l'heure de d&eacute;but`
        );
        return;
      }
    }

    try {
      // Construire le payload backend
      // Jours inactifs =&gt; null
      const payload = {
        employe_id: user.id,
      };
      JOURS.forEach((jour) =&gt; {
        const d = horairesParJour[jour];
        payload[k(jour, &quot;debut&quot;)] = d.actif ? d.debut : null;
        payload[k(jour, &quot;fin&quot;)] = d.actif ? d.fin : null;
      });

      if (horaireId) {
        await updateHoraire(horaireId, payload);
        setSuccessMessage(&quot;Votre horaire a &eacute;t&eacute; mis &agrave; jour avec succ&egrave;s !&quot;);
      } else {
        const created = await addHoraire(payload);
        setHoraireId(created?.id ?? null);
        setSuccessMessage(&quot;Votre horaire a &eacute;t&eacute; cr&eacute;&eacute; avec succ&egrave;s !&quot;);
      }
    } catch (err) {
      setError(err.message || &quot;Erreur lors de l'enregistrement de l'horaire&quot;);
    }
  };

  // Si l'utilisateur n'est pas un employ&eacute;, affiche un message d'acc&egrave;s restreint
  if (!isEmploye) {
    return (
      &lt;div className=&quot;restricted-access&quot;&gt;
        &lt;h2&gt;Acc&egrave;s Restreint&lt;/h2&gt;
        &lt;p&gt;Cette page est r&eacute;serv&eacute;e aux techniciens de FixioTech.&lt;/p&gt;
      &lt;/div&gt;
    );
  }

  if (loading) {
    return (
      &lt;div className=&quot;horaires-container&quot;&gt;
        &lt;h1 className=&quot;horaires-titres&quot;&gt;Gestion de mon horaire&lt;/h1&gt;
        &lt;div className=&quot;calendrier-section&quot;&gt;Chargement&hellip;&lt;/div&gt;
      &lt;/div&gt;
    );
  }

  return (
    &lt;div className=&quot;horaires-container&quot;&gt;
      &lt;h1 className=&quot;horaires-titres&quot;&gt;Gestion de mon horaire&lt;/h1&gt;

      {error &amp;&amp; &lt;div className=&quot;error-message&quot;&gt;{error}&lt;/div&gt;}
      {successMessage &amp;&amp; (
        &lt;div className=&quot;success-message&quot;&gt;{successMessage}&lt;/div&gt;
      )}

      &lt;div className=&quot;horaires-grid&quot;&gt;
        {/* Section des services */}
        &lt;div className=&quot;services-section&quot;&gt;
          &lt;h2 className=&quot;services-titres&quot;&gt;Mes services propos&eacute;s&lt;/h2&gt;
          &lt;div className=&quot;liste-services&quot;&gt;
            {services.map((service) =&gt; (
              &lt;label key={service} className=&quot;service-checkbox&quot;&gt;
                &lt;input
                  type=&quot;checkbox&quot;
                  checked={servicesSelectionnes.includes(service)}
                  onChange={() =&gt; handleServiceToggle(service)}
                /&gt;
                {service}
              &lt;/label&gt;
            ))}
          &lt;/div&gt;
        &lt;/div&gt;

        {/* Section des disponibilit&eacute;s */}
        &lt;div className=&quot;calendrier-section&quot;&gt;
          &lt;h2 className=&quot;calendrier-titre&quot;&gt;Mes disponibilit&eacute;s&lt;/h2&gt;
          &lt;p className=&quot;calendrier-description&quot;&gt;
            S&eacute;lectionnez les jours o&ugrave; vous &ecirc;tes disponible et d&eacute;finissez vos
            heures de d&eacute;but et de fin.
          &lt;/p&gt;

          &lt;div className=&quot;disponibilites-liste&quot;&gt;
            {JOURS.map((jour) =&gt; (
              &lt;div
                key={jour}
                className={`jour-row ${
                  horairesParJour[jour].actif ? &quot;jour-actif&quot; : &quot;&quot;
                }`}
              &gt;
                &lt;div className=&quot;jour-checkbox-container&quot;&gt;
                  &lt;label className=&quot;jour-checkbox&quot;&gt;
                    &lt;input
                      type=&quot;checkbox&quot;
                      checked={horairesParJour[jour].actif}
                      onChange={() =&gt; handleJourToggle(jour)}
                    /&gt;
                    &lt;span className=&quot;jour-nom&quot;&gt;{jour}&lt;/span&gt;
                  &lt;/label&gt;
                &lt;/div&gt;

                {horairesParJour[jour].actif &amp;&amp; (
                  &lt;div className=&quot;heures-container&quot;&gt;
                    &lt;div className=&quot;heure-groupe&quot;&gt;
                      &lt;label htmlFor={`debut-${jour}`}&gt;D&eacute;but&lt;/label&gt;
                      &lt;select
                        id={`debut-${jour}`}
                        value={horairesParJour[jour].debut}
                        onChange={(e) =&gt;
                          handleHeureDebutChange(jour, e.target.value)
                        }
                        className=&quot;heure-select&quot;
                      &gt;
                        {heuresDisponibles.map((heure) =&gt; (
                          &lt;option key={heure} value={heure}&gt;
                            {heure}
                          &lt;/option&gt;
                        ))}
                      &lt;/select&gt;
                    &lt;/div&gt;

                    &lt;span className=&quot;heure-separateur&quot;&gt;&mdash;&lt;/span&gt;

                    &lt;div className=&quot;heure-groupe&quot;&gt;
                      &lt;label htmlFor={`fin-${jour}`}&gt;Fin&lt;/label&gt;
                      &lt;select
                        id={`fin-${jour}`}
                        value={horairesParJour[jour].fin}
                        onChange={(e) =&gt;
                          handleHeureFinChange(jour, e.target.value)
                        }
                        className=&quot;heure-select&quot;
                      &gt;
                        {heuresDisponibles.map((heure) =&gt; (
                          &lt;option key={heure} value={heure}&gt;
                            {heure}
                          &lt;/option&gt;
                        ))}
                      &lt;/select&gt;
                    &lt;/div&gt;
                  &lt;/div&gt;
                )}
              &lt;/div&gt;
            ))}
          &lt;/div&gt;

          &lt;button
            className=&quot;bouton-enregistrer-horaire&quot;
            onClick={handleSauvegarder}
          &gt;
            Enregistrer mon horaire
          &lt;/button&gt;
        &lt;/div&gt;
      &lt;/div&gt;
    &lt;/div&gt;
  );
};

export default Horaires;
</div>
<script src="https://www.zeljkoobrenovic.com/tools/common/lib/ace/ace.js" type="text/javascript" charset="utf-8"></script>
<script>
    var editor = ace.edit("editor");
    editor.session.setMode("ace/mode/html");
    editor.setTheme("ace/theme/xcode");
    editor.setReadOnly(true);
    editor.setOption("wrap", true);
    editor.setPrintMarginColumn(120);
</script>
</body>
