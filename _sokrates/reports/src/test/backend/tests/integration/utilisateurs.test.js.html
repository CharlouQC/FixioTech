<html>
<head>
    <title>backend/tests/integration/utilisateurs.test.js</title>
    <style type="text/css" media="screen">
        #editor {
            position: absolute;
            top: 40px;
            right: 0;
            bottom: 0;
            left: 0;
        }
    </style>
</head>
<body style="font-family: 'DejaVu Sans', Arial, Helvetica, sans-serif">
<h3 style="margin-bottom: 0">backend/tests/integration/utilisateurs.test.js (<b>198</b> lines of code) (<a href="utilisateurs.test.js">raw</a>):</h3>
<div id="editor">import { describe, it, expect, beforeAll } from &quot;vitest&quot;;
import request from &quot;supertest&quot;;
import app from &quot;../../app.js&quot;;

describe(&quot;Tests d'int&eacute;gration - API Utilisateurs&quot;, () =&gt; {
  let testUserId;
  const testUser = {
    email: `test.integration.${Date.now()}@fixiotech.com`,
    mot_de_passe: &quot;Test1234$&quot;,
    nom_complet: &quot;Test Integration&quot;,
    role: &quot;client&quot;,
  };

  describe(&quot;POST /api/utilisateurs - Inscription&quot;, () =&gt; {
    it(&quot;devrait cr&eacute;er un nouvel utilisateur avec des donn&eacute;es valides&quot;, async () =&gt; {
      const response = await request(app)
        .post(&quot;/api/utilisateurs&quot;)
        .send(testUser)
        .expect(&quot;Content-Type&quot;, /json/)
        .expect(201);

      expect(response.body).toHaveProperty(&quot;id&quot;);
      expect(response.body.email).toBe(testUser.email);
      expect(response.body.nom_complet).toBe(testUser.nom_complet);
      expect(response.body.role).toBe(testUser.role);
      expect(response.body).not.toHaveProperty(&quot;mot_de_passe&quot;);

      testUserId = response.body.id;
    });

    it(&quot;devrait rejeter une inscription avec un email d&eacute;j&agrave; utilis&eacute;&quot;, async () =&gt; {
      const response = await request(app)
        .post(&quot;/api/utilisateurs&quot;)
        .send(testUser)
        .expect(&quot;Content-Type&quot;, /json/)
        .expect(409);

      expect(response.body).toHaveProperty(&quot;message&quot;);
      expect(response.body.message).toContain(&quot;email est d&eacute;j&agrave; utilis&eacute;&quot;);
    });

    it(&quot;devrait rejeter une inscription avec des champs manquants&quot;, async () =&gt; {
      const response = await request(app)
        .post(&quot;/api/utilisateurs&quot;)
        .send({
          email: &quot;incomplete@test.com&quot;,
          // mot_de_passe manquant
          nom_complet: &quot;Test Incomplet&quot;,
        })
        .expect(400);

      expect(response.body).toHaveProperty(&quot;message&quot;);
    });

    it(&quot;devrait rejeter une inscription avec un email invalide&quot;, async () =&gt; {
      const response = await request(app)
        .post(&quot;/api/utilisateurs&quot;)
        .send({
          email: &quot;email-invalide&quot;,
          mot_de_passe: &quot;Test1234$&quot;,
          nom_complet: &quot;Test Email Invalide&quot;,
        })
        .expect(400);

      expect(response.body).toHaveProperty(&quot;message&quot;);
    });
  });

  describe(&quot;POST /api/utilisateurs/login - Connexion&quot;, () =&gt; {
    it(&quot;devrait connecter un utilisateur avec des identifiants valides&quot;, async () =&gt; {
      const response = await request(app)
        .post(&quot;/api/utilisateurs/login&quot;)
        .send({
          email: testUser.email,
          mot_de_passe: testUser.mot_de_passe,
        })
        .expect(&quot;Content-Type&quot;, /json/)
        .expect(200);

      expect(response.body).toHaveProperty(&quot;id&quot;);
      expect(response.body.email).toBe(testUser.email);
      expect(response.body.role).toBe(testUser.role);
      expect(response.body).not.toHaveProperty(&quot;mot_de_passe&quot;);
    });

    it(&quot;devrait rejeter une connexion avec un email inexistant&quot;, async () =&gt; {
      const response = await request(app)
        .post(&quot;/api/utilisateurs/login&quot;)
        .send({
          email: &quot;inexistant@test.com&quot;,
          mot_de_passe: &quot;Test1234$&quot;,
        })
        .expect(&quot;Content-Type&quot;, /json/)
        .expect(404);

      expect(response.body).toHaveProperty(&quot;message&quot;);
      expect(response.body.message).toContain(&quot;Utilisateur non trouv&eacute;&quot;);
    });

    it(&quot;devrait rejeter une connexion avec un mot de passe incorrect&quot;, async () =&gt; {
      const response = await request(app)
        .post(&quot;/api/utilisateurs/login&quot;)
        .send({
          email: testUser.email,
          mot_de_passe: &quot;MauvaisMotDePasse123$&quot;,
        })
        .expect(&quot;Content-Type&quot;, /json/)
        .expect(401);

      expect(response.body).toHaveProperty(&quot;message&quot;);
      expect(response.body.message).toContain(&quot;Mot de passe incorrect&quot;);
    });
  });

  describe(&quot;GET /api/utilisateurs - Liste des utilisateurs&quot;, () =&gt; {
    it(&quot;devrait r&eacute;cup&eacute;rer la liste de tous les utilisateurs&quot;, async () =&gt; {
      const response = await request(app)
        .get(&quot;/api/utilisateurs&quot;)
        .expect(&quot;Content-Type&quot;, /json/)
        .expect(200);

      expect(Array.isArray(response.body)).toBe(true);
      expect(response.body.length).toBeGreaterThan(0);
      expect(response.body[0]).toHaveProperty(&quot;id&quot;);
      expect(response.body[0]).toHaveProperty(&quot;email&quot;);
      expect(response.body[0]).not.toHaveProperty(&quot;mot_de_passe&quot;);
    });

    it(&quot;devrait filtrer les utilisateurs par role&quot;, async () =&gt; {
      const response = await request(app)
        .get(&quot;/api/utilisateurs?role=client&quot;)
        .expect(&quot;Content-Type&quot;, /json/)
        .expect(200);

      expect(Array.isArray(response.body)).toBe(true);
      response.body.forEach((user) =&gt; {
        expect(user.role).toBe(&quot;client&quot;);
      });
    });
  });

  describe(&quot;GET /api/utilisateurs/:id - D&eacute;tails d'un utilisateur&quot;, () =&gt; {
    it(&quot;devrait r&eacute;cup&eacute;rer les d&eacute;tails d'un utilisateur existant&quot;, async () =&gt; {
      const response = await request(app)
        .get(`/api/utilisateurs/${testUserId}`)
        .expect(&quot;Content-Type&quot;, /json/)
        .expect(200);

      expect(response.body).toHaveProperty(&quot;id&quot;, testUserId);
      expect(response.body).toHaveProperty(&quot;email&quot;, testUser.email);
      expect(response.body).not.toHaveProperty(&quot;mot_de_passe&quot;);
    });

    it(&quot;devrait retourner 404 pour un utilisateur inexistant&quot;, async () =&gt; {
      const response = await request(app)
        .get(&quot;/api/utilisateurs/99999&quot;)
        .expect(&quot;Content-Type&quot;, /json/)
        .expect(404);

      expect(response.body).toHaveProperty(&quot;message&quot;);
      expect(response.body.message).toContain(&quot;non trouv&eacute;&quot;);
    });
  });

  describe(&quot;GET /api/utilisateurs/disponibles - Employ&eacute;s disponibles&quot;, () =&gt; {
    it(&quot;devrait r&eacute;cup&eacute;rer la liste des employ&eacute;s disponibles&quot;, async () =&gt; {
      const response = await request(app)
        .get(&quot;/api/utilisateurs/disponibles&quot;)
        .expect(&quot;Content-Type&quot;, /json/)
        .expect(200);

      expect(Array.isArray(response.body)).toBe(true);
      response.body.forEach((employe) =&gt; {
        expect(employe.role).toBe(&quot;employe&quot;);
        expect(employe).toHaveProperty(&quot;id&quot;);
        expect(employe).toHaveProperty(&quot;nom_complet&quot;);
      });
    });
  });

  describe(&quot;PUT /api/utilisateurs/:id - Modification d'un utilisateur&quot;, () =&gt; {
    it(&quot;devrait modifier les informations d'un utilisateur&quot;, async () =&gt; {
      const updates = {
        nom_complet: &quot;Test Integration Modifi&eacute;&quot;,
      };

      const response = await request(app)
        .put(`/api/utilisateurs/${testUserId}`)
        .send(updates)
        .expect(&quot;Content-Type&quot;, /json/)
        .expect(200);

      expect(response.body).toHaveProperty(&quot;message&quot;);
      expect(response.body.message).toContain(&quot;modifi&eacute;&quot;);
    });

    it(&quot;devrait retourner 404 pour la modification d'un utilisateur inexistant&quot;, async () =&gt; {
      const response = await request(app)
        .put(&quot;/api/utilisateurs/99999&quot;)
        .send({ nom_complet: &quot;Test&quot; })
        .expect(&quot;Content-Type&quot;, /json/)
        .expect(404);

      expect(response.body).toHaveProperty(&quot;message&quot;);
    });
  });

  describe(&quot;DELETE /api/utilisateurs/:id - Suppression d'un utilisateur&quot;, () =&gt; {
    it(&quot;devrait supprimer un utilisateur existant&quot;, async () =&gt; {
      const response = await request(app)
        .delete(`/api/utilisateurs/${testUserId}`)
        .expect(&quot;Content-Type&quot;, /json/)
        .expect(200);

      expect(response.body).toHaveProperty(&quot;message&quot;);
      expect(response.body.message).toContain(&quot;supprim&eacute;&quot;);
    });

    it(&quot;devrait retourner 404 pour la suppression d'un utilisateur inexistant&quot;, async () =&gt; {
      const response = await request(app)
        .delete(&quot;/api/utilisateurs/99999&quot;)
        .expect(&quot;Content-Type&quot;, /json/)
        .expect(404);

      expect(response.body).toHaveProperty(&quot;message&quot;);
    });

    it(&quot;devrait confirmer que l'utilisateur a bien &eacute;t&eacute; supprim&eacute;&quot;, async () =&gt; {
      const response = await request(app)
        .get(`/api/utilisateurs/${testUserId}`)
        .expect(&quot;Content-Type&quot;, /json/)
        .expect(404);
    });
  });
});
</div>
<script src="https://www.zeljkoobrenovic.com/tools/common/lib/ace/ace.js" type="text/javascript" charset="utf-8"></script>
<script>
    var editor = ace.edit("editor");
    editor.session.setMode("ace/mode/javascript");
    editor.setTheme("ace/theme/xcode");
    editor.setReadOnly(true);
    editor.setOption("wrap", true);
    editor.setPrintMarginColumn(120);
</script>
</body>
