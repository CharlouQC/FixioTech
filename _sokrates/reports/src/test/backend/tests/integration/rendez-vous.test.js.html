<html>
<head>
    <title>backend/tests/integration/rendez-vous.test.js</title>
    <style type="text/css" media="screen">
        #editor {
            position: absolute;
            top: 40px;
            right: 0;
            bottom: 0;
            left: 0;
        }
    </style>
</head>
<body style="font-family: 'DejaVu Sans', Arial, Helvetica, sans-serif">
<h3 style="margin-bottom: 0">backend/tests/integration/rendez-vous.test.js (<b>197</b> lines of code) (<a href="rendez-vous.test.js">raw</a>):</h3>
<div id="editor">import { describe, it, expect, beforeAll, afterAll } from &quot;vitest&quot;;
import request from &quot;supertest&quot;;
import app from &quot;../../app.js&quot;;
import { db } from &quot;../../config/databaseConnexion.js&quot;;

describe(&quot;Tests d'int&eacute;gration - API Rendez-vous&quot;, () =&gt; {
  let testClientId;
  let testEmployeId;
  let testRendezVousId;

  // Cr&eacute;er des utilisateurs de test avant tous les tests
  beforeAll(async () =&gt; {
    // Cr&eacute;er un client de test
    const [clientResult] = await db.query(
      &quot;INSERT INTO utilisateurs (email, mot_de_passe, nom_complet, role) VALUES (?, ?, ?, ?)&quot;,
      [
        `client.rdv.${Date.now()}@test.com`,
        &quot;Test1234$&quot;,
        &quot;Client RDV Test&quot;,
        &quot;client&quot;,
      ]
    );
    testClientId = clientResult.insertId;

    // Cr&eacute;er un employ&eacute; de test
    const [employeResult] = await db.query(
      &quot;INSERT INTO utilisateurs (email, mot_de_passe, nom_complet, role) VALUES (?, ?, ?, ?)&quot;,
      [
        `employe.rdv.${Date.now()}@test.com`,
        &quot;Test1234$&quot;,
        &quot;Employ&eacute; RDV Test&quot;,
        &quot;employe&quot;,
      ]
    );
    testEmployeId = employeResult.insertId;
  });

  describe(&quot;POST /api/rendezVous - Cr&eacute;ation d'un rendez-vous&quot;, () =&gt; {
    it(&quot;devrait cr&eacute;er un nouveau rendez-vous avec des donn&eacute;es valides&quot;, async () =&gt; {
      const nouveauRdv = {
        client_id: testClientId,
        employe_id: testEmployeId,
        date_rdv: &quot;2025-12-01&quot;,
        heure_rdv: &quot;10:00:00&quot;,
        service: &quot;Support technique&quot;,
        description_probleme: &quot;Test d'int&eacute;gration - Probl&egrave;me r&eacute;seau&quot;,
      };

      const response = await request(app)
        .post(&quot;/api/rendezVous&quot;)
        .send(nouveauRdv)
        .expect(&quot;Content-Type&quot;, /json/)
        .expect(201);

      expect(response.body).toHaveProperty(&quot;id&quot;);
      expect(response.body.client_id).toBe(testClientId);
      expect(response.body.employe_id).toBe(testEmployeId);
      expect(response.body.statut).toBe(&quot;Programm&eacute;&quot;);

      testRendezVousId = response.body.id;
    });

    it(&quot;devrait rejeter un rendez-vous avec des champs manquants&quot;, async () =&gt; {
      const rdvIncomplet = {
        client_id: testClientId,
        // date_rdv manquant
        heure_rdv: &quot;10:00:00&quot;,
      };

      const response = await request(app)
        .post(&quot;/api/rendezVous&quot;)
        .send(rdvIncomplet)
        .expect(400);

      expect(response.body).toHaveProperty(&quot;message&quot;);
    });

    it(&quot;devrait rejeter un rendez-vous avec un client_id inexistant&quot;, async () =&gt; {
      const rdvClientInvalide = {
        client_id: 99999,
        employe_id: testEmployeId,
        date_rdv: &quot;2025-12-01&quot;,
        heure_rdv: &quot;10:00:00&quot;,
        description_probleme: &quot;Test&quot;,
      };

      const response = await request(app)
        .post(&quot;/api/rendezVous&quot;)
        .send(rdvClientInvalide)
        .expect(400);
    });

    it(&quot;devrait rejeter un rendez-vous avec une date pass&eacute;e&quot;, async () =&gt; {
      const rdvDatePassee = {
        client_id: testClientId,
        employe_id: testEmployeId,
        date_rdv: &quot;2020-01-01&quot;,
        heure_rdv: &quot;10:00:00&quot;,
        description_probleme: &quot;Test date pass&eacute;e&quot;,
      };

      const response = await request(app)
        .post(&quot;/api/rendezVous&quot;)
        .send(rdvDatePassee)
        .expect(400);

      expect(response.body).toHaveProperty(&quot;message&quot;);
    });
  });

  describe(&quot;GET /api/rendezVous - Liste des rendez-vous&quot;, () =&gt; {
    it(&quot;devrait r&eacute;cup&eacute;rer tous les rendez-vous&quot;, async () =&gt; {
      const response = await request(app)
        .get(&quot;/api/rendezVous&quot;)
        .expect(&quot;Content-Type&quot;, /json/)
        .expect(200);

      expect(Array.isArray(response.body)).toBe(true);
      expect(response.body.length).toBeGreaterThan(0);
      expect(response.body[0]).toHaveProperty(&quot;id&quot;);
      expect(response.body[0]).toHaveProperty(&quot;date_rdv&quot;);
    });

    it(&quot;devrait filtrer les rendez-vous par client_id&quot;, async () =&gt; {
      const response = await request(app)
        .get(`/api/rendezVous?client_id=${testClientId}`)
        .expect(&quot;Content-Type&quot;, /json/)
        .expect(200);

      expect(Array.isArray(response.body)).toBe(true);
      response.body.forEach((rdv) =&gt; {
        expect(rdv.client_id).toBe(testClientId);
      });
    });

    it(&quot;devrait filtrer les rendez-vous par employe_id&quot;, async () =&gt; {
      const response = await request(app)
        .get(`/api/rendezVous?employe_id=${testEmployeId}`)
        .expect(&quot;Content-Type&quot;, /json/)
        .expect(200);

      expect(Array.isArray(response.body)).toBe(true);
      response.body.forEach((rdv) =&gt; {
        expect(rdv.employe_id).toBe(testEmployeId);
      });
    });

    it(&quot;devrait filtrer les rendez-vous par statut&quot;, async () =&gt; {
      const response = await request(app)
        .get(&quot;/api/rendezVous?statut=Programm&eacute;&quot;)
        .expect(&quot;Content-Type&quot;, /json/)
        .expect(200);

      expect(Array.isArray(response.body)).toBe(true);
      response.body.forEach((rdv) =&gt; {
        expect(rdv.statut).toBe(&quot;Programm&eacute;&quot;);
      });
    });
  });

  describe(&quot;GET /api/rendezVous/:id - D&eacute;tails d'un rendez-vous&quot;, () =&gt; {
    it(&quot;devrait r&eacute;cup&eacute;rer les d&eacute;tails d'un rendez-vous existant&quot;, async () =&gt; {
      const response = await request(app)
        .get(`/api/rendezVous/${testRendezVousId}`)
        .expect(&quot;Content-Type&quot;, /json/)
        .expect(200);

      expect(response.body).toHaveProperty(&quot;id&quot;, testRendezVousId);
      expect(response.body).toHaveProperty(&quot;client_id&quot;, testClientId);
      expect(response.body).toHaveProperty(&quot;employe_id&quot;, testEmployeId);
    });

    it(&quot;devrait retourner 404 pour un rendez-vous inexistant&quot;, async () =&gt; {
      const response = await request(app)
        .get(&quot;/api/rendezVous/99999&quot;)
        .expect(&quot;Content-Type&quot;, /json/)
        .expect(404);

      expect(response.body).toHaveProperty(&quot;message&quot;);
    });
  });

  describe(&quot;PUT /api/rendezVous/:id - Modification d'un rendez-vous&quot;, () =&gt; {
    it(&quot;devrait modifier un rendez-vous existant&quot;, async () =&gt; {
      const updates = {
        statut: &quot;Termin&eacute;&quot;,
        description_probleme: &quot;Probl&egrave;me r&eacute;solu&quot;,
      };

      const response = await request(app)
        .put(`/api/rendezVous/${testRendezVousId}`)
        .send(updates)
        .expect(&quot;Content-Type&quot;, /json/)
        .expect(200);

      expect(response.body).toHaveProperty(&quot;message&quot;);
    });

    it(&quot;devrait retourner 404 pour la modification d'un rendez-vous inexistant&quot;, async () =&gt; {
      const response = await request(app)
        .put(&quot;/api/rendezVous/99999&quot;)
        .send({ statut: &quot;Termin&eacute;&quot; })
        .expect(&quot;Content-Type&quot;, /json/)
        .expect(404);
    });

    it(&quot;devrait rejeter un statut invalide&quot;, async () =&gt; {
      const response = await request(app)
        .put(`/api/rendezVous/${testRendezVousId}`)
        .send({ statut: &quot;StatutInvalide&quot; })
        .expect(400);
    });
  });

  describe(&quot;DELETE /api/rendezVous/:id - Suppression d'un rendez-vous&quot;, () =&gt; {
    it(&quot;devrait supprimer un rendez-vous existant&quot;, async () =&gt; {
      const response = await request(app)
        .delete(`/api/rendezVous/${testRendezVousId}`)
        .expect(&quot;Content-Type&quot;, /json/)
        .expect(200);

      expect(response.body).toHaveProperty(&quot;message&quot;);
      expect(response.body.message).toContain(&quot;supprim&eacute;&quot;);
    });

    it(&quot;devrait retourner 404 pour la suppression d'un rendez-vous inexistant&quot;, async () =&gt; {
      const response = await request(app)
        .delete(&quot;/api/rendezVous/99999&quot;)
        .expect(&quot;Content-Type&quot;, /json/)
        .expect(404);
    });

    it(&quot;devrait confirmer que le rendez-vous a bien &eacute;t&eacute; supprim&eacute;&quot;, async () =&gt; {
      await request(app).get(`/api/rendezVous/${testRendezVousId}`).expect(404);
    });
  });
});
</div>
<script src="https://www.zeljkoobrenovic.com/tools/common/lib/ace/ace.js" type="text/javascript" charset="utf-8"></script>
<script>
    var editor = ace.edit("editor");
    editor.session.setMode("ace/mode/javascript");
    editor.setTheme("ace/theme/xcode");
    editor.setReadOnly(true);
    editor.setOption("wrap", true);
    editor.setPrintMarginColumn(120);
</script>
</body>
